<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>Black Pearl</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">








<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/steering-wheel.svg" alt="Black Pearl" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item is-active" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="http://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main">
    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-17T16:21:51.000Z">2019-04-18</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 minutes read (About 1871 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/17/a-glance-at-redis-cluster/">由 Eval 引申到 Redis Cluster 的学习</a>
            
        </h1>
        <div class="content">
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>因为业务需要写了一段 Redis 的 Lua Script，在调用 <code>EVAL</code> 的时候发现还有两个参数 <code>KEYS</code> 和 <code>ARGV</code>，感觉很疑惑，难道不是简单的传点参数进去就可以？所以了解了一下这两个参数的含义。</p>
<p><a href="https://redis.io/commands/eval" target="_blank" rel="noopener">EVAL</a> 命令的定义是<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>All Redis commands must be analyzed before execution to determine which keys the command will operate on. In order for this to be true for EVAL, keys must be passed explicitly. This is useful in many ways, but especially to make sure Redis Cluster can forward your request to the appropriate cluster node.</p>
</blockquote>
<p>Redis 设计的原意是使用者应当将在 Lua Script 中操作的所有 KEY 以 KEYS 的形式传给 EVAL，这样 EVAL 能够在真正运行前检查一下 KEY，就目前来说，是根据 KEYS 来决定把指令转发到哪台 Redis Cluster Master Node 上。<br>ARGV 则是传递一些必要的参数，这个倒是没什么使用规范。</p>
<p>于是我先放下 EVAL，了解一下 Redis Cluster，用了这么久 Redis 了，还没用过 Redis Cluster，惭愧。</p>
<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><p>Redis Cluster 简单的来说就是若干 Redis 节点组成集群，数据根据 KEY 被分散到不同的节点上面，而不是节点之间互为 Replication。KEY 的分散策略不是 Consistent Hashing，而是一种叫做 <strong>Slots</strong> 的机制，在文章最后我再介绍一下我对 Slots 机制的理解。<br>也正是因为 Slots 机制，指令到达 Redis Cluster 的节点之后会根据 KEY 选择合适的 Slot，然后客户端重新连接到对应的节点再执行操作，而不是某个节点转发指令到对应 KEY 的节点。<br>一个 Redis Cluster 一共有 16384 个 Slots，最开始创建集群的时候这 16384 个 Slots 会被平均分散到各个节点上面，也可以通过命令来手动调整，至于为什么是 16384 个 Slots，感兴趣的同学可以看一下作者在这个 <a href="https://github.com/antirez/redis/issues/2576" target="_blank" rel="noopener">Issue</a> 上的回答</p>
<h3 id="Availability"><a href="#Availability" class="headerlink" title="Availability"></a>Availability</h3><p>前面说到 Redis 节点之间数据互相独立，所以只要有节点挂了，这个节点负责的 Slots 的数据也变得无法访问从而整个集群的节点都会拒绝访问，处于 <code>CLUSTERDOWN</code> 的状态。<br>因此 Redis Cluster 也利用了 Master-Slave 机制用于提供 Availability，即 Master 节点会异步复制自己的数据（其实是复制操作）到它 N 个的 Slave 节点，也就是说一个 Slot 对应的 Key 们会有 N+1 份数据分布在 Master 和 Slave 上。<br>当某个 Master 挂了的时候，集群会把它的 Slave 升级到 Master，这样子集群就能继续工作。当然，如果一对 Master-Slave 都挂了那集群也就挂了。<br>通常来说，所有操作都会在 Master 上进行，Slave 只是充当备胎的作用，只有 Master 挂了 Slave 才能上位。不过 Slave 也不是一无是处，客户端可以通过执行 <code>READONLY</code> 命令来将客户端切换到只读模式，这样子读操作就会在 Slave 上进行。</p>
<h3 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h3><p>Redis Cluster 并不能保证很好的数据一致性，在某些极端情况下还是有可能丢数据的：</p>
<h4 id="第一种丢失数据的情况"><a href="#第一种丢失数据的情况" class="headerlink" title="第一种丢失数据的情况"></a>第一种丢失数据的情况</h4><p>Master 没有成功复制消息到 Slave。在 Master-Slave 模式下，对 Master 的操作是同步的，即操作成功后才会返回给客户端相应的消息，但是 Master -&gt; Slave 的复制是异步的，假设一种情况：</p>
<ol>
<li>客户端 SET a 1</li>
<li>Master 接收到指令 SET a 1，回复给客户端 OK</li>
<li>Master 在发送给 Slave SET a 1 之前崩了</li>
<li>Slave 上位成 Master<br>这时候 a=1 这个数据就丢失了。<br>这种情况也不是不能避免，Redis Cluster 提供了 WAIT 指令来做到这件事情。客户端发送 WAIT 指令之后，Redis Cluster 会 Block 住直到客户端的上一条操作有 N 个 Slave 都回复 ACK 了。</li>
</ol>
<h4 id="第二种丢失数据的情况"><a href="#第二种丢失数据的情况" class="headerlink" title="第二种丢失数据的情况"></a>第二种丢失数据的情况</h4><p>网络隔离。假设我们有一个三节点集群，每个 Master 节点有一个 Slave，节点命名为 A-A1, B-B1, C-C1，以及一个客户端 D<br>发生网络隔离的情况下，D 和少数 Master（C） 形成一个孤岛，其他大多数 Master 形成一个孤岛。</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">孤岛 A<br>D、C</th>
<th style="text-align:center">孤岛 B<br> A、A1、B、B1、C1</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">t0</td>
<td style="text-align:center">C 与集群失联，开始等待恢复连接<br>等待时间为 <code>node timeout</code><sup>[4]</sup></td>
<td style="text-align:center">集群与 B 失联，开始等待 B 恢复连接<br>等待时间为 <code>node timeout</code></td>
</tr>
<tr>
<td style="text-align:center">t1</td>
<td style="text-align:center">D 向 C 节点写数据</td>
<td style="text-align:center">持续等待</td>
</tr>
<tr>
<td style="text-align:center">t2</td>
<td style="text-align:center">C 等待超时<br>切换状态到 error，拒绝写入新数据</td>
<td style="text-align:center">集群等待超时<br>通过选举将 C1 提升为新的 Master</td>
</tr>
<tr>
<td style="text-align:center">t3</td>
<td style="text-align:center">与集群恢复联系</td>
<td style="text-align:center">与 D C 恢复联系</td>
</tr>
</tbody>
</table>
<p>恢复联系后，因为原来的 Master C 已经被多数成员认为不可用淘汰掉了，C1 被选为新的 Master，C 加回集群后被降级为 Slave。<br>因为先前 D 向 C 写的数据没有同步到 C1，所以数据丢失。</p>
<h3 id="回到-EVAL"><a href="#回到-EVAL" class="headerlink" title="回到 EVAL"></a>回到 EVAL</h3><p>在一个节点接收到 EVAL 指令之后，他会检查 KEYS，算出对应的 Slots，如果所有 KEY 不是落到同一个 Slot 上，会提示 <code>CROSSSLOT Keys in request don&#39;t hash to the same slot</code></p>
<p>那如果我不传 KEYS，直接在脚本中操作呢？还是会报错。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli EVAL &quot;redis.call(&apos;get&apos;, &apos;slot a&apos;); redis.call(&apos;get&apos;, &apos;slot-b&apos;)&quot; 0</span><br><span class="line">ERR Error running script (call to f_8ead0f68893988e15c455c0b6c8ab9982e2e707c): @user_script:1: @user_script: 1: Lua script attempted to access a non local key in a cluster node</span><br></pre></td></tr></table></figure></p>
<p>所以 EVAL 的时候，脚本中操作的 Key 应当<strong>保证落在同一个 Slot 里面</strong>。同时 Redis 也提供了一个方法可以保证 Key 都会落到同一个 Slot 上面，下面讲 Slots 机制的时候会讲到<br>以上关于 EVAL 的操作都是建立在对 Redis Cluster 操作的基础上的，如果使用的是单一节点，则可以不考虑这些问题，可以胡来。</p>
<blockquote>
<p>Note this rule is not enforced in order to provide the user with opportunities to abuse the Redis single instance configuration, at the cost of writing scripts not compatible with Redis Cluster.</p>
</blockquote>
<h3 id="Slots-机制"><a href="#Slots-机制" class="headerlink" title="Slots 机制"></a>Slots 机制</h3><blockquote>
<p>SLOT = CRC16(key) mod 16384</p>
</blockquote>
<p>Redis 集群的拓扑结构是是一个全连通的网络，每一个节点之间都会建立一个 Cluster Bus，所以集群的任何配置变动都会立即同步到各个节点，也就是说，每一个节点都知道哪些 Slot 对应哪个节点。<br>所以不论客户端连接到哪个节点进行执行指令，服务端都会正确的指示客户端应当重定向到哪一个节点来操作。<br>Key 在做 CRC16 的时候，如果 Key 中存在花括号对，Redis 会使用花括号对里面字符串做 CRC16，例如</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;user:info:&#125;1234 =&gt; crc16(&quot;user:info:&quot;) % 16384</span><br><span class="line">&#123;user:info:&#125;5737 =&gt; crc16(&quot;user:info:&quot;) % 16384</span><br></pre></td></tr></table></figure>
<p>虽然是两个不同的 Key，但是花括号中间部分是一样的，所以他们有相同的 Slot。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li>[1] <a href="https://github.com/antirez/redis/issues/2576" target="_blank" rel="noopener">https://github.com/antirez/redis/issues/2576</a></li>
<li>[2] <a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">https://redis.io/topics/cluster-spec</a></li>
<li>[3] <a href="https://redis.io/commands/eval" target="_blank" rel="noopener">https://redis.io/commands/eval</a></li>
<li>[4] <a href="https://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">https://redis.io/topics/cluster-tutorial</a></li>
</ul>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-01-16T09:00:00.000Z">2019-01-16</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 minutes read (About 542 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/01/16/365-days-challenge/">持之以恒训练打卡记录</a>
            
        </h1>
        <div class="content">
            <p><del>每天坚持做 100 个俯卧撑</del>每天坚持一项室内体育运动，暂定持续一年。没有特殊的健身目的，只是为了寻找一件事情让自己每天都努力去完成，锻炼自律性。</p>
<p>最开始的版本是一天 100 个俯卧撑，后来咨询一下发现俯卧撑是要隔天做的，因为会对肌肉产生劳损，所以打算找多几种运动来挑战，不局限于俯卧撑</p>
<ul>
<li>从 Jan.16, 2019 开始</li>
<li>到 Jan.16, 2020 结束，然后开始新的挑战</li>
</ul>
<h4 id="April"><a href="#April" class="headerlink" title="April"></a>April</h4><ul>
<li>Apr.10-18 暂停一下，这阵子身体实在不太行</li>
<li>Apr.3-9 又生病了，休息一下</li>
<li>Apr.2 俯卧撑 75 个</li>
<li>Apr.1 俯卧撑 75 个</li>
</ul>
<h4 id="March"><a href="#March" class="headerlink" title="March"></a>March</h4><ul>
<li>Mar.31 俯卧撑 75 个</li>
<li>Mar.30 俯卧撑 75 个</li>
<li>Mar.29 俯卧撑 75 个</li>
<li>Mar.28 俯卧撑 75 个</li>
<li>Mar.27 俯卧撑 75 个</li>
<li>Mar.26 俯卧撑 75 个</li>
<li>Mar.25 俯卧撑 75 个</li>
<li>Mar.24 俯卧撑 75 个</li>
<li>Mar.23 俯卧撑 75 个</li>
<li>Mar.22 俯卧撑 75 个</li>
<li>Mar.21 俯卧撑 75 个</li>
<li>Mar.20 俯卧撑 75 个</li>
<li>Mar.19 俯卧撑 75 个</li>
<li>Mar.13-18 生病了，休息一下</li>
<li>Mar.12 俯卧撑 75 个</li>
<li>Mar.11 俯卧撑 100 个</li>
<li>Mar.10 深蹲 75 个</li>
<li>Mar.9 剪蹲 75 个</li>
<li>Mar.8 俯卧撑 75 个</li>
<li>Mar.7 俯卧撑 75 个</li>
<li>Mar.6 俯卧撑 75 个</li>
<li>Mar.5 俯卧撑 75 个</li>
<li>Mar.4 俯卧撑 75 个</li>
<li>Mar.3 俯卧撑 75 个</li>
<li>Mar.2 俯卧撑 75 个</li>
<li>Mar.1 俯卧撑 75 个</li>
</ul>
<h4 id="February"><a href="#February" class="headerlink" title="February"></a>February</h4><ul>
<li>Feb.28 俯卧撑 75 个</li>
<li>Feb.27 俯卧撑 75 个</li>
<li>Feb.26 俯卧撑 75 个</li>
<li>Feb.25 俯卧撑 75 个</li>
<li>Feb.24 俯卧撑 75 个</li>
<li>Feb.23 俯卧撑 75 个</li>
<li>Feb.22 俯卧撑 75 个</li>
<li>Feb.21 俯卧撑 75 个</li>
<li>Feb.20 俯卧撑 75 个</li>
<li>Feb.19 剪蹲 100 个</li>
<li>Feb.18 俯卧撑 75 个</li>
<li>Feb.17 深蹲 100 个</li>
<li>Feb.16 仰卧起坐 100 个</li>
<li>Feb.15 剪蹲 100 个</li>
<li>Feb.14 俯卧撑 75 个</li>
<li>Feb.13 深蹲 100 个</li>
<li>Feb.12 俯卧撑 65 个</li>
<li>Feb.11 俯卧撑 75 个</li>
<li>Feb.10 俯卧撑 75 个</li>
<li>Feb.9 俯卧撑 75 个</li>
<li>Feb.8 深蹲 100 个</li>
<li>Feb.7 俯卧撑 75 个</li>
<li>Feb.6 俯卧撑 75 个</li>
<li>Feb.5 俯卧撑 75 个</li>
<li>Feb.5 俯卧撑 75 个</li>
<li>Feb.4 深蹲 100 个</li>
<li>Feb.3 剪蹲 80 个</li>
<li>Feb.2 俯卧撑 75 个</li>
<li>Feb.1 深蹲 60 个</li>
</ul>
<h4 id="January"><a href="#January" class="headerlink" title="January"></a>January</h4><ul>
<li>Jan.31 俯卧撑 50 个</li>
<li>Jan.30 俯卧撑 50 个</li>
<li>Jan.29 俯卧撑 50 个</li>
<li>Jan.28 剪蹲 100 个</li>
<li>Jan.27 俯卧撑 50 个 + 剪蹲 100 个，肩膀酸</li>
<li>Jan.26 仰卧起坐 100 个</li>
<li>Jan.25 俯卧撑 60 个</li>
<li>Jan.24 俯卧撑 60 个</li>
<li>Jan.23 俯卧撑 40 个</li>
<li>Jan.22 剪蹲 80 个</li>
<li>Jan.21 深蹲 75 个</li>
<li>Jan.20 俯卧撑 40 个</li>
<li>Jan.19 仰卧起坐 80 个</li>
<li>Jan.18 剪蹲 100 个</li>
<li>Jan.17 深蹲 80 个</li>
<li>Jan.16 俯卧撑 100 个</li>
</ul>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-07-18T16:00:57.000Z">2018-07-19</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/分享/">分享</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 minutes read (About 370 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/07/18/build-medis-on-macos/">在 macOS 上构建、打包 Medis</a>
            
        </h1>
        <div class="content">
            <p><img src="/2018/07/18/build-medis-on-macos/medis-gui-preview.png" alt="Medis GUI"></p>
<p><a href="https://github.com/luin/medis" target="_blank" rel="noopener">Medis</a> 是一款简洁易用、实用的 Redis 图形化客户端，作者将这款软件在 Github 上开源，所有开发者可以自由下载它的源代码。</p>
<p>Medis 在 App Store 上提供了下载，价值 ¥30，算是一种形式上的捐赠吧，不愿意花钱的开发者也可以根据本文的指示来构建并打包 Medis，与从 App Store下载的版本并无区别。</p>
<h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><ul>
<li>Xcode &gt;= 8.2.1</li>
<li>macOS &gt;= 10.11.6</li>
<li>Node 8（我只在装了 Node 8 的机器上尝试过）</li>
</ul>
<h3 id="自力更生"><a href="#自力更生" class="headerlink" title="自力更生"></a>自力更生</h3><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span> 1. 下载最新源代码</span><br><span class="line"><span class="hljs-meta">$</span> git clone https://github.com/luin/medis.git</span><br><span class="line">Cloning into 'medis'...</span><br><span class="line">remote: Counting objects: 3154, done.</span><br><span class="line">remote: Total 3154 (delta 0), reused 0 (delta 0), pack-reused 3154</span><br><span class="line">Receiving objects: 100% (3154/3154), 48.44 MiB | 1.89 MiB/s, done.</span><br><span class="line">Resolving deltas: 100% (1745/1745), done.</span><br><span class="line"><span class="hljs-meta">$</span> cd medis</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span> 2. 安装依赖</span><br><span class="line"><span class="hljs-meta">$</span> npm install</span><br><span class="line">...</span><br><span class="line">added 1295 packages from 1824 contributors in 49.707s</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span> 3. 打包，忽略 Unhandled rejection Error</span><br><span class="line"><span class="hljs-meta">$</span> npm run pack</span><br><span class="line">Packaging app for platform mas x64 using electron v1.4.15</span><br><span class="line">flating... ~/Desktop/medis/out/Medis-mas-x64/Medis.app</span><br><span class="line">Unhandled rejection Error: No identity found for signing.</span><br><span class="line">    at ~/Desktop/medis/node_modules/electron-osx-sign/flat.js:114:35</span><br><span class="line">	...(stack error info)</span><br></pre></td></tr></table></figure>
<p>至此，Medis 已经打包完毕，<code>Medis.app</code> 存放在 Medis 源代码目录下的 <code>out/Medis-mas-x64</code> 目录里面，运行 <code>Medis.app</code> 即可启动 Medis</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>也可以在 <code>Finder</code> 中将 <code>Medis.app</code> 放入<strong>应用程序</strong>目录来安装，也可以用运行如下命令来安装：</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span> 此时处于 Medis 源代码根目录下</span><br><span class="line"><span class="hljs-meta">$</span> mv out/Medis-mas-x64/Medis.app ~/Applications</span><br></pre></td></tr></table></figure>
<p><strong>Let’s enjoy Medis!</strong></p>
<p><strong>Thank you <a href="https://github.com/luin" target="_blank" rel="noopener">luin</a>!</strong></p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-07-06T11:10:12.000Z">2018-07-06</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    5 minutes read (About 731 words)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/07/06/learn-k8s-1/">Kubernetes 学习札记 - 在 Google Cloud 上搭建集群</a>
            
        </h1>
        <div class="content">
            <h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><ul>
<li>搭建 Kubernetes 集群（Master <em> 1 + Node </em> 2）</li>
</ul>
<h4 id="Machines"><a href="#Machines" class="headerlink" title="Machines"></a>Machines</h4><table>
<thead>
<tr>
<th>Hostname</th>
<th>Machine Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>kube-master</td>
<td>n1-standard</td>
</tr>
<tr>
<td>kube-node-1</td>
<td>n1-standard</td>
</tr>
<tr>
<td>kube-node-2</td>
<td>n1-standard</td>
</tr>
</tbody>
</table>
<h4 id="Preparation-on-Master-Machine"><a href="#Preparation-on-Master-Machine" class="headerlink" title="Preparation on Master Machine"></a>Preparation on Master Machine</h4><ol>
<li><p>安装 <code>Docker</code> 和 <code>Kubeadm</code></p>
<p>保存下面脚本为 <code>init-k8s-master.sh</code></p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span>!/bin/sh</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span> install docker</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -</span><br><span class="line">sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y docker-ce</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span> install k8s</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line">echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" &gt;&gt; /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span> ONLY run on master</span><br><span class="line"><span class="hljs-meta">#</span> configure cgroup</span><br><span class="line">sed -i "s/cgroup-driver=systemd/cgroup-driver=cgroupfs/g" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<p>执行上述脚本 <code>sudo source init-k8s-master.sh</code></p>
</li>
<li><p>选择一个 Pod 网络组件（Pod Network Add-on）</p>
<p>组件有很多种，这里我选择了 <code>Flannel</code>，具体操作见接下来两个步骤</p>
</li>
<li><p>启动集群 Master</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span> 这里的 --pod-network-cidr=10.244.0.0/16 取决于你选择的网络组件</span><br><span class="line">sudo kubeadm init --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>
<p>启动了之后从结果的最后几行里面获得一串命令行，用于操作 Node 加入集群，记下来，这个命令行有用</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span> 获得一串类似于这样子的命令</span><br><span class="line"><span class="hljs-meta">#</span> 10.0.0.3 是我的 Master IP</span><br><span class="line">kubeadm join 10.0.0.3:6443 --token 8qn683.9ft7dc6xa0re697a --discovery-token-ca-cert-hash sha256:65773046272db8297b64cbc1ce8ebc3884fa932976673fad7715c2bd8c53c6a0</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置环境变量，方便调用 <code>kubectl</code></p>
<p>如果想让非 root 用户使用 <code>kubectl</code> ，执行</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<p>对于 root 用户，直接设置环境变量</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>
<p>这样设置之后， <code>kubectl</code> 才能正常运行</p>
</li>
<li><p>安装网络组件</p>
<p>检查节点</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> kubectl get nodes</span><br><span class="line">NAME          STATUS       ROLES     AGE       VERSION</span><br><span class="line">kube-master   NotReady     master    1m        v1.11.0</span><br></pre></td></tr></table></figure>
<p>会发现 STATUS 为 NotReady ，运行 <code>kubectl describe nodes</code> 得到最后一行日志是 <code>Container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized</code> ，说明网络组件还没有配置好，需要设置一下。</p>
<p>这里我选择了 <code>Flannel</code> 作为网络组件，执行</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>再次检查节点</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> kubectl get nodes</span><br><span class="line">NAME          STATUS    ROLES     AGE       VERSION</span><br><span class="line">kube-master   Ready     master    2m        v1.11.0</span><br></pre></td></tr></table></figure>
<p>至此 Master 配置完毕，准备配置 Node</p>
</li>
</ol>
<h4 id="Preparation-for-Node-Machines"><a href="#Preparation-for-Node-Machines" class="headerlink" title="Preparation for Node Machines"></a>Preparation for Node Machines</h4><ol>
<li><p>安装 <code>Docker</code> 和 <code>Kubeadm</code></p>
<p>参照 Master 安装教程，删去 <code>cgroup</code> 配置部分</p>
</li>
<li><p>加入集群</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span> 在 Master 进行 kubeadm init 的时候获得的提示</span><br><span class="line">kubeadm join 10.0.0.3:6443 --token 8qn683.9ft7dc6xa0re697a --discovery-token-ca-cert-hash sha256:65773046272db8297b64cbc1ce8ebc3884fa932976673fad7715c2bd8c53c6a0</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查节点状态</p>
<p>在 Master 上执行 <code>kubectl get nodes</code></p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> kubectl get nodes</span><br><span class="line">NAME          STATUS    ROLES     AGE       VERSION</span><br><span class="line">kube-master   Ready     master    2m        v1.11.0</span><br><span class="line">kube-node-1   Ready     master    3m        v1.11.0</span><br><span class="line">kube-node-2   Ready     master    3m        v1.11.0</span><br></pre></td></tr></table></figure>
<p>所有 STATUS 均为 Ready，完美</p>
</li>
</ol>
<p>资料参考：</p>
<ul>
<li><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">Creating a single master cluster with kubeadm</a></li>
</ul>

        </div>
        
        
        
    </div>
</div>








</div>
                
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/./images/avatar.jpg" alt="Tony Ke">
                    
                    
                    <p class="is-size-4 is-block">
                        Tony Ke
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Backend Engineer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Mirage</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <p class="title has-text-weight-normal">
                        4
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Category
                    </p>
                    <p class="title has-text-weight-normal">
                        1
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <p class="title has-text-weight-normal">
                        6
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="http://github.com/thagki9">
                Follow</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="http://github.com/thagki9">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/分享/">
            <span class="level-start">
                <span class="level-item">分享</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-04-17T16:21:51.000Z">2019-04-18</time></div>
                    <a href="/2019/04/17/a-glance-at-redis-cluster/" class="has-link-black-ter is-size-6">由 Eval 引申到 Redis Cluster 的学习</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-01-16T09:00:00.000Z">2019-01-16</time></div>
                    <a href="/2019/01/16/365-days-challenge/" class="has-link-black-ter is-size-6">持之以恒训练打卡记录</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-07-18T16:00:57.000Z">2018-07-19</time></div>
                    <a href="/2018/07/18/build-medis-on-macos/" class="has-link-black-ter is-size-6">在 macOS 上构建、打包 Medis</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/分享/">分享</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-07-06T11:10:12.000Z">2018-07-06</time></div>
                    <a href="/2018/07/06/learn-k8s-1/" class="has-link-black-ter is-size-6">Kubernetes 学习札记 - 在 Google Cloud 上搭建集群</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Archives
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">April 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">January 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">July 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/DIY/">
                        <span class="tag">DIY</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Medis/">
                        <span class="tag">Medis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/kubernetes/">
                        <span class="tag">kubernetes</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/redis/">
                        <span class="tag">redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/study/">
                        <span class="tag">study</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/学习札记/">
                        <span class="tag">学习札记</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/steering-wheel.svg" alt="Black Pearl" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Tony Ke&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="http://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en-US");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>